{% extends "base.html" %}

{% block title %}QR Scanner - {{ class_info.class_name }} {{ class_info.section }}{% endblock %}

{% block head %}
<!-- HTML5 QR Scanner -->
<script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="h3 mb-0">QR Scanner - {{ class_info.class_name }} {{ class_info.section }}</h1>
                <div>
                    <a href="{{ url_for('teacher.take_attendance', class_id=class_info.id) }}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> Back to Attendance
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- QR Scanner -->
        <div class="col-lg-8 mb-4">
            <div class="card shadow">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">QR Code Scanner</h6>
                </div>
                <div class="card-body">
                    <div id="qrScanner" style="width: 100%; height: 500px;"></div>
                    <div class="mt-3 text-center">
                        <button class="btn btn-primary btn-lg" onclick="startQRScanner()">
                            <i class="fas fa-play"></i> Start Scanning
                        </button>
                        <button class="btn btn-secondary btn-lg" onclick="stopQRScanner()">
                            <i class="fas fa-stop"></i> Stop Scanning
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Scanner Controls and Info -->
        <div class="col-lg-4 mb-4">
            <div class="card shadow">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Scanner Controls</h6>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <button class="btn btn-info btn-block" onclick="toggleTorch()">
                            <i class="fas fa-flashlight"></i> Toggle Flashlight
                        </button>
                    </div>
                    <div class="mb-3">
                        <button class="btn btn-warning btn-block" onclick="switchQRCamera()">
                            <i class="fas fa-sync"></i> Switch Camera
                        </button>
                    </div>
                    <div class="mb-3">
                        <button class="btn btn-success btn-block" onclick="setScanTimeout(30)">
                            <i class="fas fa-clock"></i> Set 30s Timeout
                        </button>
                    </div>
                    
                    <div class="alert alert-info">
                        <h6><i class="fas fa-info-circle"></i> Instructions</h6>
                        <ul class="mb-0">
                            <li>Point camera at student's QR code</li>
                            <li>Ensure good lighting</li>
                            <li>Hold steady for 2-3 seconds</li>
                            <li>Wait for confirmation beep</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Scans -->
    <div class="row">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Recent Scans</h6>
                </div>
                <div class="card-body">
                    <div id="recentScans">
                        <div class="text-center py-4">
                            <i class="fas fa-qrcode fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">No scans yet</h5>
                            <p class="text-muted">Start scanning to see recent activity</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Hidden input for class ID -->
<input type="hidden" id="classId" value="{{ class_info.id }}">
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/qr-scanner.js') }}"></script>

<script>
let recentScans = [];

// Initialize QR scanner page
document.addEventListener('DOMContentLoaded', function() {
    // Initialize QR scanner
    initializeQRScanner('qrScanner', onQRCodeDetected);
    
    // Load recent scans
    loadRecentScans();
});

// QR code detection handler
function onQRCodeDetected(qrData) {
    const classId = document.getElementById('classId').value;
    
    // Send QR data to server
    fetch('/teacher/scan-qr', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            qr_data: qrData,
            class_id: classId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification(`Attendance marked for ${data.student.name}`, 'success');
            
            // Add to recent scans
            addRecentScan(data.student);
            
            // Show success modal
            showScanSuccessModal(data.student);
        } else {
            showNotification(data.error, 'error');
        }
    })
    .catch(error => {
        console.error('Error processing QR code:', error);
        showNotification('Error processing QR code', 'error');
    });
}

// Add recent scan
function addRecentScan(student) {
    const scan = {
        student: student,
        timestamp: new Date().toLocaleTimeString()
    };
    
    recentScans.unshift(scan);
    if (recentScans.length > 10) {
        recentScans = recentScans.slice(0, 10);
    }
    
    updateRecentScansDisplay();
}

// Update recent scans display
function updateRecentScansDisplay() {
    const container = document.getElementById('recentScans');
    
    if (recentScans.length === 0) {
        container.innerHTML = `
            <div class="text-center py-4">
                <i class="fas fa-qrcode fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">No scans yet</h5>
                <p class="text-muted">Start scanning to see recent activity</p>
            </div>
        `;
        return;
    }
    
    let html = '<div class="list-group list-group-flush">';
    recentScans.forEach(scan => {
        html += `
            <div class="list-group-item d-flex justify-content-between align-items-center">
                <div>
                    <h6 class="mb-1">${scan.student.name}</h6>
                    <small class="text-muted">ID: ${scan.student.student_id} | Roll: ${scan.student.roll_number}</small>
                </div>
                <div class="text-end">
                    <span class="badge badge-success">Present</span>
                    <br>
                    <small class="text-muted">${scan.timestamp}</small>
                </div>
            </div>
        `;
    });
    html += '</div>';
    
    container.innerHTML = html;
}

// Show scan success modal
function showScanSuccessModal(student) {
    const modal = document.createElement('div');
    modal.className = 'modal fade';
    modal.id = 'scanSuccessModal';
    modal.innerHTML = `
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Attendance Marked Successfully</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center">
                    <div class="mb-3">
                        <i class="fas fa-check-circle fa-3x text-success"></i>
                    </div>
                    <h5>${student.name}</h5>
                    <p class="text-muted">Student ID: ${student.student_id}</p>
                    <p class="text-muted">Roll Number: ${student.roll_number}</p>
                    <p class="text-success"><strong>Attendance marked successfully!</strong></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Continue Scanning</button>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    const bootstrapModal = new bootstrap.Modal(modal);
    bootstrapModal.show();
    
    modal.addEventListener('hidden.bs.modal', function() {
        modal.remove();
    });
}

// Load recent scans from server
function loadRecentScans() {
    const classId = document.getElementById('classId').value;
    
    fetch(`/api/attendance-summary/${classId}`)
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Convert present students to recent scans format
            recentScans = data.present_students.map(student => ({
                student: {
                    name: student.full_name,
                    student_id: student.student_id,
                    roll_number: student.roll_number
                },
                timestamp: student.time_marked ? new Date(student.time_marked).toLocaleTimeString() : 'Unknown'
            }));
            
            updateRecentScansDisplay();
        }
    })
    .catch(error => {
        console.error('Error loading recent scans:', error);
    });
}

// Start QR scanner
function startQRScanner() {
    if (typeof qrScannerManager !== 'undefined') {
        qrScannerManager.startQRScanning();
    }
}

// Stop QR scanner
function stopQRScanner() {
    if (typeof qrScannerManager !== 'undefined') {
        qrScannerManager.stopQRScanning();
    }
}

// Toggle torch
function toggleTorch() {
    if (typeof qrScannerManager !== 'undefined') {
        qrScannerManager.toggleTorch();
    }
}

// Switch camera
function switchQRCamera() {
    if (typeof qrScannerManager !== 'undefined') {
        qrScannerManager.switchQRCamera();
    }
}

// Set scan timeout
function setScanTimeout(seconds) {
    if (typeof qrScannerManager !== 'undefined') {
        qrScannerManager.setScanTimeout(seconds);
    }
}
</script>
{% endblock %}