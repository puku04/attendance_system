{% extends "base.html" %}

{% block title %}Manage Teachers - Smart Attendance System{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="h3 mb-0">Manage Teachers</h1>
                <div>
                    <button class="btn btn-primary" onclick="openAddTeacherModal()">
                        <i class="fas fa-user-plus"></i> Add Teacher
                    </button>
                    <button class="btn btn-success" onclick="exportTeachers()">
                        <i class="fas fa-download"></i> Export
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Search and Filter -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="input-group">
                <input type="text" class="form-control" id="searchInput" placeholder="Search teachers...">
                <div class="input-group-append">
                    <button class="btn btn-outline-secondary" type="button" onclick="searchTeachers()">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <select class="form-control" id="statusFilter" onchange="filterByStatus()">
                <option value="">All Status</option>
                <option value="active">Active</option>
                <option value="inactive">Inactive</option>
            </select>
        </div>
        <div class="col-md-3">
            <button class="btn btn-info btn-block" onclick="bulkAssignClasses()">
                <i class="fas fa-chalkboard"></i> Assign Classes
            </button>
        </div>
    </div>

    <!-- Teachers Table -->
    <div class="row">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Teachers List</h6>
                </div>
                <div class="card-body">
                    {% if teachers %}
                    <div class="table-responsive">
                        <table class="table table-bordered" id="teachersTable">
                            <thead>
                                <tr>
                                    <th>Username</th>
                                    <th>Full Name</th>
                                    <th>Email</th>
                                    <th>Classes Assigned</th>
                                    <th>Status</th>
                                    <th>Created Date</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for teacher in teachers %}
                                <tr data-teacher-id="{{ teacher.id }}">
                                    <td>{{ teacher.username }}</td>
                                    <td>{{ teacher.full_name }}</td>
                                    <td>{{ teacher.email }}</td>
                                    <td>
                                        <span class="badge badge-info">{{ teacher.class_count or 0 }} classes</span>
                                    </td>
                                    <td>
                                        {% if teacher.is_active %}
                                        <span class="badge badge-success">Active</span>
                                        {% else %}
                                        <span class="badge badge-danger">Inactive</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ teacher.created_at.strftime('%d/%m/%Y') if teacher.created_at else '-' }}</td>
                                    <td>
                                        <div class="btn-group" role="group">
                                            <button class="btn btn-sm btn-info" onclick="viewTeacher('{{ teacher.id }}')" 
                                                    data-bs-toggle="tooltip" title="View Details">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            <button class="btn btn-sm btn-warning" onclick="editTeacher('{{ teacher.id }}')" 
                                                    data-bs-toggle="tooltip" title="Edit">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button class="btn btn-sm btn-success" onclick="assignClasses('{{ teacher.id }}')" 
                                                    data-bs-toggle="tooltip" title="Assign Classes">
                                                <i class="fas fa-chalkboard"></i>
                                            </button>
                                            <button class="btn btn-sm btn-danger" onclick="deleteTeacher('{{ teacher.id }}')" 
                                                    data-bs-toggle="tooltip" title="Delete">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-chalkboard-teacher fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">No teachers found</h5>
                        <p class="text-muted">Start by adding your first teacher</p>
                        <button class="btn btn-primary" onclick="openAddTeacherModal()">
                            <i class="fas fa-user-plus"></i> Add Teacher
                        </button>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Teacher Modal -->
<div class="modal fade" id="addTeacherModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Teacher</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="addTeacherForm">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="username" class="form-label">Username *</label>
                            <input type="text" class="form-control" id="username" name="username" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="full_name" class="form-label">Full Name *</label>
                            <input type="text" class="form-control" id="full_name" name="full_name" required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="email" class="form-label">Email *</label>
                            <input type="email" class="form-control" id="email" name="email" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="password" class="form-label">Password *</label>
                            <input type="password" class="form-control" id="password" name="password" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="role" class="form-label">Role</label>
                        <select class="form-control" id="role" name="role">
                            <option value="teacher">Teacher</option>
                            <option value="principal">Principal</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Teacher</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Teacher Details Modal -->
<div class="modal fade" id="teacherDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Teacher Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="teacherDetailsContent">
                <!-- Teacher details will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="editTeacherFromModal()">Edit Teacher</button>
            </div>
        </div>
    </div>
</div>

<!-- Assign Classes Modal -->
<div class="modal fade" id="assignClassesModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Assign Classes to Teacher</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="assignClassesContent">
                    <!-- Classes assignment will be loaded here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveClassAssignments()">Save Assignments</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentTeacherId = null;

// Search functionality
function searchTeachers() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const rows = document.querySelectorAll('#teachersTable tbody tr');
    
    rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(searchTerm) ? '' : 'none';
    });
}

// Filter by status
function filterByStatus() {
    const selectedStatus = document.getElementById('statusFilter').value;
    const rows = document.querySelectorAll('#teachersTable tbody tr');
    
    rows.forEach(row => {
        if (!selectedStatus) {
            row.style.display = '';
        } else {
            const statusCell = row.cells[4].textContent.toLowerCase();
            const isActive = statusCell.includes('active');
            const shouldShow = (selectedStatus === 'active' && isActive) || 
                             (selectedStatus === 'inactive' && !isActive);
            row.style.display = shouldShow ? '' : 'none';
        }
    });
}

// Open add teacher modal
function openAddTeacherModal() {
    const modal = new bootstrap.Modal(document.getElementById('addTeacherModal'));
    modal.show();
}

// Add teacher form submission
document.getElementById('addTeacherForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const data = Object.fromEntries(formData);
    
    fetch('/auth/register', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('Teacher added successfully!', 'success');
            bootstrap.Modal.getInstance(document.getElementById('addTeacherModal')).hide();
            location.reload();
        } else {
            showNotification(data.error, 'error');
        }
    })
    .catch(error => {
        console.error('Error adding teacher:', error);
        showNotification('Error adding teacher', 'error');
    });
});

// View teacher details
function viewTeacher(teacherId) {
    currentTeacherId = teacherId;
    
    fetch(`/api/teachers/${teacherId}`)
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const teacher = data.teacher;
            document.getElementById('teacherDetailsContent').innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <table class="table table-borderless">
                            <tr><td><strong>Username:</strong></td><td>${teacher.username}</td></tr>
                            <tr><td><strong>Full Name:</strong></td><td>${teacher.full_name}</td></tr>
                            <tr><td><strong>Email:</strong></td><td>${teacher.email}</td></tr>
                            <tr><td><strong>Role:</strong></td><td>${teacher.role}</td></tr>
                            <tr><td><strong>Status:</strong></td><td>
                                ${teacher.is_active ? '<span class="badge badge-success">Active</span>' : '<span class="badge badge-danger">Inactive</span>'}
                            </td></tr>
                            <tr><td><strong>Created:</strong></td><td>${teacher.created_at || '-'}</td></tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6>Assigned Classes</h6>
                        <div id="assignedClasses">
                            <!-- Classes will be loaded here -->
                        </div>
                    </div>
                </div>
            `;
            
            const modal = new bootstrap.Modal(document.getElementById('teacherDetailsModal'));
            modal.show();
        } else {
            showNotification(data.error, 'error');
        }
    })
    .catch(error => {
        console.error('Error fetching teacher details:', error);
        showNotification('Error fetching teacher details', 'error');
    });
}

// Edit teacher
function editTeacher(teacherId) {
    window.location.href = `/principal/edit-teacher/${teacherId}`;
}

// Assign classes
function assignClasses(teacherId) {
    currentTeacherId = teacherId;
    
    // Load available classes
    fetch('/api/classes')
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const classes = data.classes;
            const assignedClasses = data.assigned_classes || [];
            
            let html = '<div class="row">';
            classes.forEach(cls => {
                const isAssigned = assignedClasses.some(ac => ac.id === cls.id);
                html += `
                    <div class="col-md-6 mb-2">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="${cls.id}" 
                                   id="class_${cls.id}" ${isAssigned ? 'checked' : ''}>
                            <label class="form-check-label" for="class_${cls.id}">
                                ${cls.class_name} - ${cls.section}
                            </label>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            
            document.getElementById('assignClassesContent').innerHTML = html;
            
            const modal = new bootstrap.Modal(document.getElementById('assignClassesModal'));
            modal.show();
        } else {
            showNotification(data.error, 'error');
        }
    })
    .catch(error => {
        console.error('Error loading classes:', error);
        showNotification('Error loading classes', 'error');
    });
}

// Save class assignments
function saveClassAssignments() {
    const checkboxes = document.querySelectorAll('#assignClassesContent input[type="checkbox"]');
    const assignedClasses = Array.from(checkboxes)
        .filter(cb => cb.checked)
        .map(cb => cb.value);
    
    fetch(`/api/teachers/${currentTeacherId}/assign-classes`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            class_ids: assignedClasses
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('Classes assigned successfully!', 'success');
            bootstrap.Modal.getInstance(document.getElementById('assignClassesModal')).hide();
            location.reload();
        } else {
            showNotification(data.error, 'error');
        }
    })
    .catch(error => {
        console.error('Error assigning classes:', error);
        showNotification('Error assigning classes', 'error');
    });
}

// Delete teacher
function deleteTeacher(teacherId) {
    if (confirm('Are you sure you want to delete this teacher? This action cannot be undone.')) {
        fetch(`/api/teachers/${teacherId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification('Teacher deleted successfully', 'success');
                document.querySelector(`tr[data-teacher-id="${teacherId}"]`).remove();
            } else {
                showNotification(data.error, 'error');
            }
        })
        .catch(error => {
            console.error('Error deleting teacher:', error);
            showNotification('Error deleting teacher', 'error');
        });
    }
}

// Export teachers
function exportTeachers() {
    window.open('/api/export/teachers', '_blank');
}

// Bulk assign classes
function bulkAssignClasses() {
    showNotification('Bulk class assignment feature coming soon', 'info');
}

// Initialize search on input
document.getElementById('searchInput').addEventListener('input', searchTeachers);

// Initialize tooltips
document.addEventListener('DOMContentLoaded', function() {
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function(tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
});
</script>
{% endblock %}
